<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>SysStatz - Dashboard</title>
    <link rel="stylesheet" th:href="@{'/css/' + ${theme}}">
	<link rel="icon" href="/img/logo.png" type="image/png">
	<style>
		button {
			padding: 10px 20px;
			background-color: #4a90e2;
			color: white;
			border: none;
			border-radius: 6px;
			font-size: 1rem;
			cursor: pointer;
			transition: background-color 0.3s ease, transform 0.2s ease;
			box-shadow: 0 4px 8px rgba(0,0,0,0.3);
			margin: 0.5rem 0;
		}
		
		button:hover {
			background-color: #357bd8;
			transform: translateY(-1px);
		}
		
		.button-link {
		    display: inline-block;
		    padding: 8px 16px;
		    background-color: #007bff;
		    color: white;
		    text-decoration: none;
		    border-radius: 4px;
		    border: none;
		    font-size: 14px;
		}
		.button-link:hover {
		    background-color: #0056b3;
		}
		
		nav {
		  display: flex;
		  justify-content: space-between;
		  align-items: center;
		  padding-right: 1rem;
		  flex-wrap: wrap; /* falls Zeilenumbruch gewünscht */
		}

		nav > div {
		  display: flex;
		  gap: 0.5rem; /* Abstand zwischen Buttons */
		  flex-wrap: wrap;
		  align-items: center;
		}

		/* Responsive: bei schmalen Bildschirmen */
		@media (max-width: 600px) {
		  nav {
		    flex-direction: column;
		    align-items: flex-start;
		    padding-right: 0;
		  }

		  nav > div {
		    width: 100%;
		    justify-content: flex-start;
		    margin-bottom: 0.5rem;
		  }

		  nav > div:last-child {
		    margin-bottom: 0;
		  }

		  /* Suchleiste volle Breite */
		  nav > div:last-child input[type="text"] {
		    width: 100%;
		    box-sizing: border-box;
		  }
		}
		
		/* Sidebar-Container */
		.sidebar {
		    position: fixed;
		    top: 0;
		    left: 0;
		    height: 100%;
		    background-color: #2b2f36;
		    width: 60px;
		    transition: width 0.3s ease;
		    overflow-x: hidden;
		    box-shadow: 2px 0 8px rgba(0,0,0,0.3);
		    display: flex;
		    flex-direction: column;
		    align-items: center;
		    padding-top: 0.5rem;
		    z-index: 1000;
		}

		/* Ausgeklappt */
		.sidebar.expanded {
		    width: 200px;
		    align-items: flex-start;
		    padding-left: 10px;
		}

		/* Menü-Button */
		.sidebar-toggle {
		    background: transparent;
		    border: none;
		    padding: 6px;
		    cursor: pointer;
		    margin-bottom: 1rem;
		    transition: transform 0.2s ease;
		}

		.sidebar-toggle img {
		    height: 24px;
		    filter: brightness(0) invert(1);
		}

		.sidebar-toggle:hover {
		    transform: scale(1.1);
		}

		/* Links in Sidebar */
		.sidebar a {
		    display: flex;
		    align-items: center;
		    padding: 10px;
		    color: white;
		    text-decoration: none;
		    border-radius: 6px;
		    width: 100%;
		    transition: background-color 0.2s;
		}
		
		.sidebar a.active {
		    background-color: #357bd8;
		    box-shadow: 0 0 10px #357bd8;
		    font-weight: bold;
		}


		/* Eingeklappt → nur Icon mittig */
		.sidebar:not(.expanded) a {
		    justify-content: center;
		    padding: 10px 0;
		}

		/* Hover */
		.sidebar a:hover {
		    background-color: #4a90e2;
		    color: white;
		}

		.sidebar a:hover img {
		    filter: brightness(1.5) drop-shadow(0 0 3px #fff);
		}


		/* Icon */
		.sidebar img {
		    height: 28px; /* größer */
		    margin-right: 10px;
		    filter: brightness(1.2); /* Icons etwas heller */
		    transition: filter 0.3s ease;
		}

		.sidebar a:hover img,
		.sidebar a.active img {
		    filter: brightness(1.5) drop-shadow(0 0 2px #4a90e2);
		}


		/* Text ausblenden, wenn eingeklappt */
		.sidebar:not(.expanded) .link-text {
		    display: none;
		}
		
		/* Standardbreite der Sidebar (eingeklappt) */
		body {
		  margin-left: 60px;
		  transition: margin-left 0.3s ease;
		}

		/* Wenn Sidebar ausgeklappt ist, mehr Abstand */
		body.sidebar-expanded {
		  margin-left: 200px;
		}
	</style>
</head>
<body>
<header>
    <h1>
		<img src="/img/logo.png" alt="SysStatz Logo" style="height: 3em; vertical-align: middle; margin-right: 5px;">
		SysStatz - Dashboard
	</h1>
</header>

<div class="sidebar" id="sidebar">
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <img src="/img/menu.png" alt="Menu" style="height: 24px;">
    </button>
	<a th:href="@{/dashboard}" th:classappend="${activePage == 'dashboard'} ? ' active' : ''">
	    <img src="/img/dashboard.png" alt="Dashboard">
	    <span class="link-text">Dashboard</span>
	</a>
    <a th:href="@{/analyze}" th:classappend="${activePage == 'analyze'} ? ' active' : ''">
        <img src="/img/analyse.png" alt="Analyse">
        <span class="link-text">Analyse</span>
    </a>
    <a th:href="@{/settings}" th:classappend="${activePage == 'settings'} ? ' active' : ''">
        <img src="/img/settings.png" alt="Einstellungen">
        <span class="link-text">Einstellungen</span>
    </a>
    <a th:href="@{/logs}" th:classappend="${activePage == 'logs'} ? ' active' : ''">
        <img src="/img/log.png" alt="Logs">
        <span class="link-text">Logs</span>
    </a>
    <a th:href="@{/compare}" th:classappend="${activePage == 'compare'} ? ' active' : ''">
        <img src="/img/compare.png" alt="Vergleichen">
        <span class="link-text">Vergleichen</span>
    </a>
	<a th:href="@{/alerts}" th:classappend="${activePage == 'alerts'} ? ' active' : ''">
	    <img src="/img/alert.png" alt="Meldungen ">
	    <span class="link-text">Meldungen</span>
	</a>
	<a th:href="@{/pdf-export}" th:classappend="${activePage == 'pdf-export'} ? ' active' : ''">
	    <img src="/img/pdf.png" alt="PDF-Creator ">
	    <span class="link-text">PDF-Creator</span>
	</a>
	<a th:if="${isAdmin}" th:href="@{/admin/manageUsers}" th:classappend="${activePage == 'manageUsers'} ? ' active' : ''">
	    <img src="/img/users.png" alt="Benutzer">
	    <span class="link-text">Benutzer</span>
	</a>
	<a th:if="${isAdmin}" th:href="@{/filemanager}" th:classappend="${activePage == 'filemanager'} ? ' active' : ''">
	    <img src="/img/folder.png" alt="Ordner">
	    <span class="link-text">Dateimanager</span>
	</a>
</div>

<div id="servers-container">
    <!-- Server-Infos werden hier dynamisch eingefügt -->
</div>

<script>
	
	const API_KEY = 'pv983qa4EHNZt';
	
	function format3(val) {
	    const n = Number(val);
	    if (!Number.isFinite(n)) return val;
	    return n.toLocaleString('de-DE', {
	        minimumFractionDigits: 0,
	        maximumFractionDigits: 3
	    });
	}
	
async function refreshData() {
    try {
        const response = await fetch('/api/servers');
        if (!response.ok) {
            console.error('Fehler beim Laden der Serverdaten');
            return;
        }
		
        const servers = await response.json();
        const container = document.getElementById('servers-container');
        container.innerHTML = ''; // vorher leeren

		if (servers.length === 0) {
		    const message = document.createElement('p');
		    message.textContent = 'Keine Serverdaten verfügbar.';
		    message.style.color = 'gray';
		    message.style.fontSize = '1.2rem';
		    message.style.textAlign = 'center';
		    container.appendChild(message);
		} else {
			servers.forEach(server => {
			    const div = document.createElement('div');
				
				const cpuUsage = parseFloat(server.cpuPercent);
				    let borderColor = '';
				    let warningText = '';

				    if (cpuUsage >= 90) {
				        borderColor = 'red';
				        warningText = '<p style="color: red; font-weight: bold;">⚠ WARNING: CPU über 90%</p>';
				    } else if (cpuUsage >= 70) {
				        borderColor = 'orange';
				        warningText = '<p style="color: orange; font-weight: bold;">⚠ WARNING: CPU über 70%</p>';
				    }

				    div.style.border = borderColor ? `3px solid ${borderColor}` : '';
				    div.style.borderRadius = '8px';
				    div.style.padding = '20px';
				    div.style.marginBottom = '10px';

			    const scmdEnabled = String(server.scmd).toLowerCase() === 'true';

			    div.innerHTML = `
			        <h2><img src="/img/server.png" alt="Server Icon" style="height: 1em;"> ${server.name}</h2>
					${warningText}
			        <p>STATUS: ${server.status}</p>
			        <p><img src="/img/cpu.png" alt="CPU Icon" style="height: 1em;"> CPU: ${server.cpuPercent}%</p>
			        <p><img src="/img/ram.png" alt="RAM Icon" style="height: 1em;"> RAM: ${format3(server.ramUsed)} Gb / ${format3(server.ramTotal)} Gb</p>
			        <p><img src="/img/ssd.png" alt="SSD Icon" style="height: 1em;"> STORAGE: ${server.storageUsed} Gb / ${server.storageTotal} Gb</p>
			        <p><img src="/img/network.png" alt="Logs Icon" style="height: 1em;"> NETWORK: ↑ ${format3(server.dsend)} ↓ ${format3(server.drecv)}</p>
					<p><img src="/img/temp.png" alt="Logs Icon" style="height: 1em;"> CPU-TEMP: ${server.temp}</p>
			        <div style="display: flex; gap: 5px; margin-bottom: 5px;">
			            ${scmdEnabled ? `
			            <div style="display: flex; gap: 5px; margin-top: 5px;">
			                <button title="Stop" style="
			                    background-color: #c84c4c;
			                    border: none;
			                    border-radius: 8px;
			                    padding: 12px;
			                    cursor: pointer;
			                    display: flex;
			                    align-items: center;
			                    justify-content: center;
			                    width: 48px;
			                    height: 48px;
			                    transition: background-color 0.2s ease;
			                " onmouseover="this.style.backgroundColor='#a83838'"
			                   onmouseout="this.style.backgroundColor='#c84c4c'"
			                   onclick="sendServerCommand('${server.name}', 'stop')">
			                    <img src="/img/stop.png" alt="Stop Icon" style="height: 24px;">
			                </button>

			                <button title="Reboot" style="
			                    background-color: #7cb5e0;
			                    border: none;
			                    border-radius: 8px;
			                    padding: 12px;
			                    cursor: pointer;
			                    display: flex;
			                    align-items: center;
			                    justify-content: center;
			                    width: 48px;
			                    height: 48px;
			                    transition: background-color 0.2s ease;
			                " onmouseover="this.style.backgroundColor='#5a9dc9'"
			                   onmouseout="this.style.backgroundColor='#7cb5e0'"
			                   onclick="sendServerCommand('${server.name}', 'reboot')">
			                    <img src="/img/reboot.png" alt="Reboot Icon" style="height: 24px;">
			                </button>
			            </div>
			            ` : ''}
			        </div>
			        <a href="/server/${encodeURIComponent(server.name)}">
			            <button><img src="/img/details.png" alt="Details Icon" style="height: 1em; margin-right: 5px;"> Details anzeigen</button>
			        </a>
			        <a href="/compare">
			            <button><img src="/img/compare.png" alt="Compare Icon" style="height: 1em; margin-right: 5px;"> Server vergleichen</button>
			        </a>
			    `;

			    container.appendChild(div);
			    div.setAttribute("data-server-name", server.name.toLowerCase());
			});
		}


    } catch (error) {
        console.error('Fehler:', error);
    }
}

// Daten beim Laden der Seite und alle 5 Sekunden aktualisieren
refreshData();
setInterval(refreshData, 5000);


document.getElementById('server-search').addEventListener('input', function () {
    const query = this.value.toLowerCase();
    const serverDivs = document.querySelectorAll('#servers-container > div');

    serverDivs.forEach(div => {
        const name = div.getAttribute('data-server-name');
        if (!name.includes(query)) {
            div.style.display = 'none';
        } else {
            div.style.display = '';
        }
    });
});


// Hilfsfunktion zum Senden von Stop/Reboot-Befehl
async function sendServerCommand(name, action) {
    const url = `/api/server/${encodeURIComponent(name)}/${action}?key=${API_KEY}`;
    try {
        const response = await fetch(url, { method: 'POST' });
        const result = await response.json();
        if (response.ok) {
            alert(`Aktion erfolgreich: ${result.status}`);
        } else {
            alert(`Fehler: ${result.error || 'Unbekannt'}`);
        }
    } catch (err) {
        console.error('Fehler beim Senden des Befehls:', err);
        alert('Netzwerkfehler oder Server nicht erreichbar.');
    }
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('expanded');
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('expanded');

    // body margin anpassen
    if (sidebar.classList.contains('expanded')) {
        document.body.classList.add('sidebar-expanded');
    } else {
        document.body.classList.remove('sidebar-expanded');
    }
}
</script>
</body>
</html>
