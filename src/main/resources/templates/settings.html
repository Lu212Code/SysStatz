<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SysStatz - Einstellungen</title>
    <link rel="stylesheet" th:href="@{'/css/' + ${theme}}">
	<link rel="icon" href="/img/logo.png" type="image/png">
	<style>
	/* Allgemeines Styling */
	input[type="text"], input[type="password"], select {
	    padding: 8px 12px;
	    font-size: 1rem;
	    border: 2px solid #4a90e2;
	    border-radius: 6px;
	    outline: none;
	    transition: border-color 0.3s ease;
	    width: 250px;
	    box-sizing: border-box;
	    background-color: #1e1e1e;
	    color: #ffffff;
	}

	input[type="text"]:focus, input[type="password"]:focus, select:focus {
	    border-color: #357bd8;
	    box-shadow: 0 0 5px rgba(53, 123, 216, 0.5);
	}

	button {
	    padding: 10px 20px;
	    background-color: #4a90e2;
	    color: white;
	    border: none;
	    border-radius: 6px;
	    font-size: 1rem;
	    cursor: pointer;
	    transition: background-color 0.3s ease, transform 0.2s ease;
	    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
	    margin: 0.5rem 0;
	}

	button:hover {
	    background-color: #357bd8;
	    transform: translateY(-1px);
	}

	section {
	    background-color: #2b2e3d;
	    padding: 1em;
	    border-radius: 10px;
	    margin-bottom: 1.5em;
	    box-shadow: 0 3px 6px rgba(0,0,0,0.3);
	}

	.collapsible {
	    background-color: #1f2230;
	    color: white;
	    cursor: pointer;
	    padding: 10px;
	    width: 100%;
	    border: none;
	    text-align: left;
	    outline: none;
	    font-size: 1.1rem;
	    margin-bottom: 0.5em;
	    border-radius: 6px;
	}

	.active, .collapsible:hover {
	    background-color: #30344a;
	}

	.content {
	    display: none;
	    padding-top: 0.5em;
	}

	/* Switch Styling */
	.switch-wrapper {
	    display: flex;
	    align-items: center; /* Text vertikal zentrieren */
	    gap: 10px; /* Abstand zwischen Switch und Text */
	    margin: 0.5em 0;
	}

	.switch {
	    position: relative;
	    display: inline-block;
	    width: 50px;
	    height: 24px;
	    flex-shrink: 0;
	}

	.switch input {
	    opacity: 0;
	    width: 0;
	    height: 0;
	}

	.slider {
	    position: absolute;
	    cursor: pointer;
	    top: 0; left: 0;
	    right: 0; bottom: 0;
	    background-color: #ccc;
	    transition: .4s;
	    border-radius: 24px;
	}

	.slider:before {
	    position: absolute;
	    content: "";
	    height: 18px;
	    width: 18px;
	    left: 3px;
	    bottom: 3px;
	    background-color: white;
	    transition: .4s;
	    border-radius: 50%;
	}

	input:checked + .slider {
	    background-color: #4a90e2; /* SysStatz Hellblau */
	}

	input:checked + .slider:before {
	    transform: translateX(26px);
	}
	
	.update-indicator {
	    display: inline-block;
	    width: 10px;
	    height: 10px;
	    margin-left: 8px;
	    background-color: red;
	    border-radius: 50%;
	    vertical-align: middle;
	    box-shadow: 0 0 6px rgba(255, 0, 0, 0.7);
	    animation: pulse 1.5s infinite;
	}

	@keyframes pulse {
	    0%   { transform: scale(1); opacity: 1; }
	    50%  { transform: scale(1.4); opacity: 0.6; }
	    100% { transform: scale(1); opacity: 1; }
	}
	</style>
	<link rel="stylesheet" th:href="@{'/css/' + ${theme} + '-sidebar.css'}">
</head>
<body>
<header>
    <h1>
        SysStatz - Einstellungen
    </h1>
</header>

<div th:replace="fragments/sidebar :: sidebar"></div>

<!-- Abschnitt: Allgemeine Einstellungen -->
<section>
    <button class="collapsible">Allgemeine Einstellungen</button>
    <div class="content">
        <form th:action="@{/settings/save}" method="post">
			
			<section th:if="${isAdmin}">
            <p>Webserver Port: <input type="text" name="webPort" th:value="${config.webPort}"></p>
            <p>Statsserver Port: <input type="text" name="statsPort" th:value="${config.statsPort}"></p>
			<p>Ollama Server IP: <input type="text" name="ollamaserverip" th:value="${config.ollamaserverip}"></p>
			<p>Client Passwort: <input type="text" name="clientPassword" th:value="${config.clientPassword}"></p>
			<p>API-Key: <input type="text" name="apiKey" th:value="${config.apiKey}"></p>
			<div class="switch-wrapper">
			    <label class="switch">
			        <input type="checkbox" name="twoFactorRequired" th:checked="${config.twoFactorRequired}" />
			        <span class="slider round"></span>
			    </label>
			    <span>2-Faktor-Authentifizierung erzwingen</span>
			</div>
			</section>
            <p>Website Theme:
                <select name="theme">
                    <option th:selected="${config.theme == 'default'}" value="default">Default</option>
                    <option th:selected="${config.theme == 'copper'}" value="copper">Copper</option>
                    <option th:selected="${config.theme == 'fresh_green'}" value="fresh_green">Fresh Green</option>
                </select>
            </p>
            <button type="submit">Speichern</button>
        </form>
    </div>
</section>


<!-- Abschnitt: Serververwaltung -->
<section th:if="${isAdmin}">
    <button class="collapsible">Serververwaltung</button>
    <div class="content">
        <h3>Serverliste</h3>
        <table>
            <thead>
                <tr>
                    <th>IP</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="server : ${servers}">
                    <td th:text="${server}"></td>
                    <td>
                        <button type="button" class="remove-btn" th:data-ip="${server}">L√∂schen</button>
                    </td>
                </tr>
            </tbody>
        </table>
		
		<h3>Abgelehnte Verbindungsversuche</h3>
		<table id="blockedTable">
		    <thead>
		        <tr>
		            <th>IP</th>
		            <th>Aktionen</th>
		        </tr>
		    </thead>
		    <tbody>
		        <!-- Wird per JS geladen -->
		    </tbody>
		</table>


        <h3>Neuen Server Manuell hinzuf√ºgen</h3>
        <form id="addServerForm">
            <input type="text" id="serverIp" name="ip" placeholder="Server-IP">
            <button type="submit">Hinzuf√ºgen</button>
            <p id="ipError" style="color: red; display: none;">‚ùå Ung√ºltige IP-Adresse</p>
            <p id="serverMsg" style="color: green; display: none;"></p>
        </form>
    </div>
</section>

<!-- Abschnitt: Alert-Mail Einstellungen -->
<section th:if="${isAdmin}">
    <button class="collapsible">Alert-Mail Einstellungen</button>
    <div class="content">
        <form th:action="@{/settings/save}" method="post">
            <div class="switch-wrapper">
                <label class="switch">
                    <input type="checkbox" name="enableAlertMail" th:checked="${config.enableAlertMail}" />
                    <span class="slider round"></span>
                </label>
                <span>Alert-Mails aktivieren</span>
            </div>

            <h4>Mail-Adressen verwalten</h4>
			<div th:each="entry : ${mails}">
			    <p>
			        Benutzername: <input type="text" th:name="'mails[' + ${entry.key} + ']'" th:value="${entry.value}" />
					<button type="button" class="delete-mail-btn" th:attr="data-key=${entry.key}">L√∂schen</button>
			    </p>
			</div>

            <p>Neuen Benutzer hinzuf√ºgen:</p>
            <p>
                Benutzername: <input type="text" name="newMailUser" />
                E-Mail: <input type="text" name="newMailAddress" />
            </p>

            <button type="submit">Speichern</button>
        </form>
    </div>
</section>

<!-- Abschnitt: SysStatz Updates -->
<section th:if="${isAdmin}">
    <button class="collapsible">
        SysStatz Update
        <span th:if="${updateAvailable}" class="update-indicator"></span>
    </button>
    <div class="content">
        <p>Aktuelle SysStatz-Version: <span th:text="${currentVersion}"></span></p>
        <p>Neueste SysStatz-Version: <span th:text="${latestVersion}"></span></p>

        <div th:if="${updateAvailable}">
            <button id="updateBtn">Update starten</button>
        </div>
        <div th:if="${!updateAvailable}">
            <p>‚úÖ SysStatz ist aktuell.</p>
        </div>
    </div>
</section>

<!-- Popup -->
<div id="updatePopup" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.7); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:#2b2e3d; padding:20px; border-radius:10px; width:350px; text-align:center;">
        <h3>Update best√§tigen</h3>
        <p>SysStatz wird kurz nicht verf√ºgbar sein, w√§hrend das Update installiert wird.</p>
        <p>Fortsetzen?</p>
        <button id="confirmUpdateBtn">Fortsetzen</button>
        <button id="cancelUpdateBtn">Abbrechen</button>
    </div>
</div>

<!-- Abschnitt: Benutzerverwaltung (Admin only) -->
<section th:if="${isAdmin}">
        <a th:href="@{/admin/manageUsers}">
        <button>User-Management</button>
    </a>
</section>

<!-- Help Button -->
<section>
    <a th:href="@{/help}">
        <button>Hilfe und Dokumentation</button>
    </a>
</section>

<script>
    const collapsibles = document.querySelectorAll(".collapsible");
    collapsibles.forEach(button => {
        button.addEventListener("click", () => {
            button.classList.toggle("active");
            const content = button.nextElementSibling;
            if (content.style.display === "block") {
                content.style.display = "none";
            } else {
                content.style.display = "block";
            }
        });
    });
	
	const form = document.getElementById('addServerForm');
	form.addEventListener('submit', async function(event) {
	    event.preventDefault(); // Form nicht normal abschicken

	    const ipInput = document.getElementById('serverIp');
	    const ipError = document.getElementById('ipError');
	    const serverMsg = document.getElementById('serverMsg');

	    const ip = ipInput.value.trim();

	    // IPv4 Regex
	    const ipv4Pattern = /^(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}$/;
	    // IPv6 Regex
	    const ipv6Pattern = /^(([0-9a-fA-F]{1,4}:){7}([0-9a-fA-F]{1,4}|:))$|^(([0-9a-fA-F]{1,4}:){1,7}:)$|^:((:[0-9a-fA-F]{1,4}){1,7})$/;

	    if (!ipv4Pattern.test(ip) && !ipv6Pattern.test(ip)) {
	        ipError.style.display = 'block';
	        serverMsg.style.display = 'none';
	        return;
	    }

	    ipError.style.display = 'none';

	    try {
	        const response = await fetch('/servers/add', {
	            method: 'POST',
	            headers: { 'Content-Type': 'application/json' },
	            body: JSON.stringify({ ip })
	        });
	        const data = await response.json();

			if (response.ok) {
			    serverMsg.style.color = 'green';
			    serverMsg.textContent = `‚úÖ ${data.status}: ${data.ip}`;
			    serverMsg.style.display = 'block';
			    
			    // Neue Zeile in die Tabelle einf√ºgen
			    const tbody = document.querySelector('table tbody');
			    const tr = document.createElement('tr');
			    tr.innerHTML = `
			        <td>${data.ip}</td>
			        <td>
			            <button type="button" onclick="removeServer('${data.ip}')">L√∂schen</button>
			        </td>
			    `;
			    tbody.appendChild(tr);

			    ipInput.value = '';
			} else {
	            serverMsg.style.color = 'red';
	            serverMsg.textContent = `‚ùå ${data.error}`;
	            serverMsg.style.display = 'block';
	        }
	    } catch (err) {
	        serverMsg.style.color = 'red';
	        serverMsg.textContent = `‚ùå Fehler beim Hinzuf√ºgen`;
	        serverMsg.style.display = 'block';
	    }
	});
	
	document.addEventListener("click", (e) => {
	        if (e.target.classList.contains("remove-btn")) {
	            const ip = e.target.dataset.ip; // echte IP aus data-Attribut
	            removeServer(ip, e.target);
	        }
	    });
	
	async function removeServer(ip, button) {
	    console.log("üëâ Sende removeServer:", ip);

	    try {
	        const response = await fetch('/servers/remove', {
	            method: 'POST',
	            headers: { 'Content-Type': 'application/json' },
	            body: JSON.stringify({ ip: ip.trim() })
	        });

	        console.log("üì• Remove Response raw:", response);
	        const data = await response.json();
	        console.log("üì• Remove Response JSON:", data);

	        if (response.ok) {
	            console.log("‚úÖ Entfernt:", data);
	            button.closest('tr').remove();
	        } else {
	            console.warn("‚ö†Ô∏è Fehler beim Entfernen:", data);
	        }
	    } catch (err) {
	        console.error("‚ùå Netzwerk/JS Fehler:", err);
	    }
	}
	
	async function loadBlockedIPs() {
	    try {
	        const response = await fetch('/blocked');
	        const blocked = await response.json();

	        const tbody = document.querySelector('#blockedTable tbody');
	        tbody.innerHTML = ''; // alte Eintr√§ge l√∂schen

	        blocked.forEach(ip => {
	            const tr = document.createElement('tr');
	            tr.innerHTML = `
	                <td>${ip}</td>
	                <td>
	                    <button onclick="acceptBlocked('${ip}')">√úbernehmen</button>
	                    <button onclick="rejectBlocked('${ip}')">L√∂schen</button>
	                </td>
	            `;
	            tbody.appendChild(tr);
	        });
	    } catch (err) {
	        console.error("‚ùå Fehler beim Laden der Blockliste", err);
	    }
	}

	async function acceptBlocked(ip) {
	    await fetch('/blocked/accept', {
	        method: 'POST',
	        headers: { 'Content-Type': 'application/json' },
	        body: JSON.stringify({ ip })
	    });
	    loadBlockedIPs(); // Liste neu laden
	}

	async function rejectBlocked(ip) {
	    await fetch('/blocked/reject', {
	        method: 'POST',
	        headers: { 'Content-Type': 'application/json' },
	        body: JSON.stringify({ ip })
	    });
	    loadBlockedIPs(); // Liste neu laden
	}

	// Beim Laden der Seite direkt starten
	document.addEventListener("DOMContentLoaded", loadBlockedIPs);
	
	document.addEventListener('click', e => {
	    if (e.target.classList.contains('delete-mail-btn')) {
	        const key = e.target.dataset.key; // ‚Üê hier holen wir den Wert!
	        console.log("Delete clicked", key); // Optional zum Debuggen
	        fetch('/settings/deleteMail', {
	            method: 'POST',
	            headers: {'Content-Type':'application/json'},
	            body: JSON.stringify({ key })
	        })
	        .then(res => res.json())
	        .then(data => {
	            if(data.success) e.target.closest('p').remove();
	        });
	    }
	});
	
	document.addEventListener("DOMContentLoaded", () => {
	    const updateBtn = document.getElementById("updateBtn");
	    const popup = document.getElementById("updatePopup");
	    const confirmBtn = document.getElementById("confirmUpdateBtn");
	    const cancelBtn = document.getElementById("cancelUpdateBtn");

	    if (updateBtn) {
	        updateBtn.addEventListener("click", () => {
	            popup.style.display = "flex";
	        });
	    }

	    if (cancelBtn) {
	        cancelBtn.addEventListener("click", () => {
	            popup.style.display = "none";
	        });
	    }

	    if (confirmBtn) {
	        confirmBtn.addEventListener("click", async () => {
	            confirmBtn.disabled = true;
	            confirmBtn.innerText = "Update l√§uft...";

	            try {
	                await fetch("/update/start", { method: "POST" });
	                // Server beendet sich selbst ‚Üí hier kann nichts mehr zur√ºckkommen
	            } catch (err) {
	                alert("‚ùå Fehler beim Starten des Updates: " + err);
	            }
	        });
	    }
	});
</script>
<script src="/js/sidebar.js"></script>
</body>
</html>
