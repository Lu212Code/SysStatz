<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="de">
<head>
    <meta charset="UTF-8">
    <title>Server vergleichen</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
	<link rel="icon" href="/img/logo.png" type="image/png">
    <link rel="stylesheet" th:href="@{'/css/' + ${theme}}">
    <style>
		body {
		    background-color: #1e1e2f;
		    color: #ddd;
		    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
		    padding: 20px;
		    margin: 0;
			margin-left: 60px;
			transition: margin-left 0.3s ease;
		}

		h1 {
		    text-align: center;
		    color: #4a90e2;
		    border-bottom: 2px solid #4a90e2;
		    padding-bottom: 10px;
		    margin-bottom: 20px;
		}

		.container {
		    display: flex;
		    justify-content: space-between;
		    gap: 1rem;
		    flex-wrap: wrap;
		}

		.server-panel {
		    flex: 1;
		    background-color: #1e2433; /* geänderte Farbe */
		    padding: 1rem;
		    border-radius: 12px; /* größer */
		    box-shadow: 0 4px 12px rgba(0,0,0,0.6);
		    min-width: 300px;
		}

		.server-panel h2 {
		    color: #7fbfff;
		    margin-top: 0;
		    margin-bottom: 0.5rem;
		}

		select {
		    width: 100%;
		    padding: 8px;
		    border-radius: 5px;
		    border: 1px solid #444;
		    background-color: #1e1e2f;
		    color: #fff;
		    margin-bottom: 1rem;
		}

		canvas {
		    width: 100% !important;
		    max-height: 400px;
		    aspect-ratio: 3 / 2;
		    background-color: #1e2433;
		    border-radius: 12px;
		    margin-bottom: 1rem;
		}

		table {
		    width: 100%;
		    border-collapse: collapse;
		    margin-top: 1rem;
		    background-color: #1e1e2f;
		}

		th, td {
		    border: 1px solid #4a90e2;
		    padding: 0.5rem;
		    text-align: center;
		}

		th {
		    background-color: #2c2f48;
		    color: #7fbfff;
		}

		td {
		    color: #eee;
		}
		
		button {
			padding: 10px 20px;
			background-color: #4a90e2;
			color: white;
			border: none;
			border-radius: 6px;
			font-size: 1rem;
			cursor: pointer;
			transition: background-color 0.3s ease, transform 0.2s ease;
			box-shadow: 0 4px 8px rgba(0,0,0,0.3);
			margin: 0.5rem 0;
		}

		button:hover {
			background-color: #357bd8;
			transform: translateY(-1px);
		}

		.button-link {
		    display: inline-block;
		    padding: 8px 16px;
		    background-color: #007bff;
		    color: white;
		    text-decoration: none;
		    border-radius: 4px;
		    border: none;
		    font-size: 14px;
		}
		.button-link:hover {
		    background-color: #0056b3;
		}
    </style>
	<link rel="stylesheet" th:href="@{'/css/' + ${theme} + '-sidebar.css'}">
</head>
<body>

<h1>Serververgleich</h1>

<div th:replace="fragments/sidebar :: sidebar"></div>

<div class="container">
    <div class="server-panel">
        <h2>Server A</h2>
        <select id="serverASelect"></select>
        <canvas id="cpuChartA"></canvas>
        <canvas id="ramChartA"></canvas>
        <canvas id="diskChartA"></canvas>
        <table>
            <tr><th>CPU (%)</th><th>RAM (%)</th><th>Disk (%)</th></tr>
            <tr><td id="cpuAvgA">-</td><td id="ramAvgA">-</td><td id="diskAvgA">-</td></tr>
        </table>
    </div>

    <div class="server-panel">
        <h2>Server B</h2>
        <select id="serverBSelect"></select>
        <canvas id="cpuChartB"></canvas>
        <canvas id="ramChartB"></canvas>
        <canvas id="diskChartB"></canvas>
        <table>
            <tr><th>CPU (%)</th><th>RAM (%)</th><th>Disk (%)</th></tr>
            <tr><td id="cpuAvgB">-</td><td id="ramAvgB">-</td><td id="diskAvgB">-</td></tr>
        </table>
    </div>
</div>

<script>
	const charts = {};
	const serverASelect = document.getElementById('serverASelect');
	const serverBSelect = document.getElementById('serverBSelect');

	async function fetchServers() {
	    const response = await fetch('/api/servers');
	    const data = await response.json();
	    return data;
	}

	async function fetchHistory(serverName) {
	    const response = await fetch(`/api/server/${serverName}/history`);
	    return response.json();
	}

	function avg(arr) {
	    if (!arr.length) return 0;
	    return arr.reduce((a, b) => a + b, 0) / arr.length;
	}

	function getGlobalMax(arr1, arr2) {
	    return Math.max(...arr1, ...arr2) * 1.1; // +10% für etwas Abstand
	}

	const colors = {
	    'CPU (%)': {border: 'rgba(255, 99, 132, 1)', background: 'rgba(255, 99, 132, 0.2)'},
	    'RAM (%)': {border: 'rgba(54, 162, 235, 1)', background: 'rgba(54, 162, 235, 0.25)'},
	    'Disk (%)': {border: 'rgba(255, 206, 86, 1)', background: 'rgba(255, 206, 86, 0.2)'}
	};

	function drawChart(id, labels, data, label, maxY) {
	    const ctx = document.getElementById(id).getContext('2d');
	    const color = colors[label] || {border: '#4a90e2', background: '#4a90e2'};
	    if (charts[id]) charts[id].destroy();
	    charts[id] = new Chart(ctx, {
	        type: 'line',
	        data: { labels, datasets: [{ label, data, fill: true, borderColor: color.border, backgroundColor: color.background, tension: 0.3, pointRadius: 2, borderWidth: 2 }] },
	        options: {
	            responsive: true,
	            maintainAspectRatio: false,
	            plugins: {
	                legend: { display: true, labels: { color: '#ddd', font: { size: 14 } } },
	                datalabels: { color: '#ddd', font: { weight: 'bold' }, display: false, align: 'top', formatter: value => value.toFixed(1) }
	            },
	            scales: {
	                x: { ticks: { color: '#ccc' }, grid: { color: '#333' } },
	                y: { ticks: { color: '#ccc' }, grid: { color: '#333' }, beginAtZero: true, max: maxY }
	            }
	        },
	        plugins: [ChartDataLabels],
	    });
	}

	async function loadBothServers() {
	    const serverAName = serverASelect.value;
	    const serverBName = serverBSelect.value;

	    const [historyA, historyB] = await Promise.all([
	        fetchHistory(serverAName),
	        fetchHistory(serverBName)
	    ]);

	    const cpuA = historyA.map(d => d.cpuPercent);
	    const cpuB = historyB.map(d => d.cpuPercent);
	    const ramA = historyA.map(d => d.ramUsed);
	    const ramB = historyB.map(d => d.ramUsed);
	    const diskA = historyA.map(d => d.diskPercent);
	    const diskB = historyB.map(d => d.diskPercent);

	    const cpuMax = getGlobalMax(cpuA, cpuB);
	    const ramMax = getGlobalMax(ramA, ramB);
	    const diskMax = getGlobalMax(diskA, diskB);

	    const labelsA = historyA.map(d => new Date(d.timestamp).toLocaleTimeString());
	    const labelsB = historyB.map(d => new Date(d.timestamp).toLocaleTimeString());

	    drawChart('cpuChartA', labelsA, cpuA, 'CPU (%)', cpuMax);
	    drawChart('cpuChartB', labelsB, cpuB, 'CPU (%)', cpuMax);

	    drawChart('ramChartA', labelsA, ramA, 'RAM (%)', ramMax);
	    drawChart('ramChartB', labelsB, ramB, 'RAM (%)', ramMax);

	    drawChart('diskChartA', labelsA, diskA, 'Disk (%)', diskMax);
	    drawChart('diskChartB', labelsB, diskB, 'Disk (%)', diskMax);

	    document.getElementById('cpuAvgA').textContent = avg(cpuA).toFixed(1);
	    document.getElementById('cpuAvgB').textContent = avg(cpuB).toFixed(1);
	    document.getElementById('ramAvgA').textContent = avg(ramA).toFixed(1);
	    document.getElementById('ramAvgB').textContent = avg(ramB).toFixed(1);
	    document.getElementById('diskAvgA').textContent = avg(diskA).toFixed(1);
	    document.getElementById('diskAvgB').textContent = avg(diskB).toFixed(1);
	}

	async function init() {
	    const servers = await fetchServers();

	    servers.forEach(server => {
	        const optA = new Option(server.name, server.name);
	        const optB = new Option(server.name, server.name);
	        serverASelect.appendChild(optA);
	        serverBSelect.appendChild(optB);
	    });

	    serverASelect.addEventListener('change', loadBothServers);
	    serverBSelect.addEventListener('change', loadBothServers);

	    if (servers.length >= 2) {
	        serverASelect.value = servers[0].name;
	        serverBSelect.value = servers[1].name;
	        loadBothServers();
	    }
	}

	init();
</script>
<script src="/js/sidebar.js"></script>
</body>
</html>
