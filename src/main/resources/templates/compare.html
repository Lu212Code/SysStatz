<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="de">
<head>
    <meta charset="UTF-8">
    <title>Server vergleichen</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
	<link rel="icon" href="/img/logo.png" type="image/png">
    <link rel="stylesheet" th:href="@{'/css/' + ${theme}}">
    <style>
		body {
		    background-color: #1e1e2f;
		    color: #ddd;
		    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
		    padding: 20px;
		    margin: 0;
			margin-left: 60px;
			transition: margin-left 0.3s ease;
		}

		h1 {
		    text-align: center;
		    color: #4a90e2;
		    border-bottom: 2px solid #4a90e2;
		    padding-bottom: 10px;
		    margin-bottom: 20px;
		}

		.container {
		    display: flex;
		    justify-content: space-between;
		    gap: 1rem;
		    flex-wrap: wrap;
		}

		.server-panel {
		    flex: 1;
		    background-color: #1e2433; /* geänderte Farbe */
		    padding: 1rem;
		    border-radius: 12px; /* größer */
		    box-shadow: 0 4px 12px rgba(0,0,0,0.6);
		    min-width: 300px;
		}

		.server-panel h2 {
		    color: #7fbfff;
		    margin-top: 0;
		    margin-bottom: 0.5rem;
		}

		select {
		    width: 100%;
		    padding: 8px;
		    border-radius: 5px;
		    border: 1px solid #444;
		    background-color: #1e1e2f;
		    color: #fff;
		    margin-bottom: 1rem;
		}

		canvas {
		    width: 100% !important;
		    max-height: 400px;
		    aspect-ratio: 3 / 2;
		    background-color: #1e2433;
		    border-radius: 12px;
		    margin-bottom: 1rem;
		}

		table {
		    width: 100%;
		    border-collapse: collapse;
		    margin-top: 1rem;
		    background-color: #1e1e2f;
		}

		th, td {
		    border: 1px solid #4a90e2;
		    padding: 0.5rem;
		    text-align: center;
		}

		th {
		    background-color: #2c2f48;
		    color: #7fbfff;
		}

		td {
		    color: #eee;
		}
		
		button {
			padding: 10px 20px;
			background-color: #4a90e2;
			color: white;
			border: none;
			border-radius: 6px;
			font-size: 1rem;
			cursor: pointer;
			transition: background-color 0.3s ease, transform 0.2s ease;
			box-shadow: 0 4px 8px rgba(0,0,0,0.3);
			margin: 0.5rem 0;
		}

		button:hover {
			background-color: #357bd8;
			transform: translateY(-1px);
		}

		.button-link {
		    display: inline-block;
		    padding: 8px 16px;
		    background-color: #007bff;
		    color: white;
		    text-decoration: none;
		    border-radius: 4px;
		    border: none;
		    font-size: 14px;
		}
		.button-link:hover {
		    background-color: #0056b3;
		}
		
		/* Sidebar-Container */
				.sidebar {
				    position: fixed;
				    top: 0;
				    left: 0;
				    height: 100%;
				    background-color: #2b2f36;
				    width: 60px;
				    transition: width 0.3s ease;
				    overflow-x: hidden;
				    box-shadow: 2px 0 8px rgba(0,0,0,0.3);
				    display: flex;
				    flex-direction: column;
				    align-items: center;
				    padding-top: 0.5rem;
				    z-index: 1000;
				}

				/* Ausgeklappt */
				.sidebar.expanded {
				    width: 200px;
				    align-items: flex-start;
				    padding-left: 10px;
				}

				/* Menü-Button */
				.sidebar-toggle {
				    background: transparent;
				    border: none;
				    padding: 6px;
				    cursor: pointer;
				    margin-bottom: 1rem;
				    transition: transform 0.2s ease;
				}

				.sidebar-toggle img {
				    height: 24px;
				    filter: brightness(0) invert(1);
				}

				.sidebar-toggle:hover {
				    transform: scale(1.1);
				}

				/* Links in Sidebar */
				.sidebar a {
				    display: flex;
				    align-items: center;
				    padding: 10px;
				    color: white;
				    text-decoration: none;
				    border-radius: 6px;
				    width: 100%;
				    transition: background-color 0.2s;
				}
				
				.sidebar a.active {
				    background-color: #357bd8;
				    box-shadow: 0 0 10px #357bd8;
				    font-weight: bold;
				}


				/* Eingeklappt → nur Icon mittig */
				.sidebar:not(.expanded) a {
				    justify-content: center;
				    padding: 10px 0;
				}

				/* Hover */
				.sidebar a:hover {
				    background-color: #4a90e2;
				    color: white;
				}

				.sidebar a:hover img {
				    filter: brightness(1.5) drop-shadow(0 0 3px #fff);
				}


				/* Icon */
				.sidebar img {
				    height: 28px; /* größer */
				    margin-right: 10px;
				    filter: brightness(1.2); /* Icons etwas heller */
				    transition: filter 0.3s ease;
				}

				.sidebar a:hover img,
				.sidebar a.active img {
				    filter: brightness(1.5) drop-shadow(0 0 2px #4a90e2);
				}


				/* Text ausblenden, wenn eingeklappt */
				.sidebar:not(.expanded) .link-text {
				    display: none;
				}

				/* Wenn Sidebar ausgeklappt ist, mehr Abstand */
				body.sidebar-expanded {
				  margin-left: 200px;
				}
    </style>
</head>
<body>

<h1>Serververgleich</h1>

<div class="sidebar" id="sidebar">
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <img src="/img/menu.png" alt="Menu" style="height: 24px;">
    </button>
	<a th:href="@{/dashboard}" th:classappend="${activePage == 'dashboard'} ? ' active' : ''">
	    <img src="/img/dashboard.png" alt="Dashboard">
	    <span class="link-text">Dashboard</span>
    <a th:href="@{/analyze}" th:classappend="${activePage == 'analyze'} ? ' active' : ''">
        <img src="/img/analyse.png" alt="Analyse">
        <span class="link-text">Analyse</span>
    </a>
    <a th:href="@{/settings}" th:classappend="${activePage == 'settings'} ? ' active' : ''">
        <img src="/img/settings.png" alt="Einstellungen">
        <span class="link-text">Einstellungen</span>
    </a>
    <a th:href="@{/logs}" th:classappend="${activePage == 'logs'} ? ' active' : ''">
        <img src="/img/log.png" alt="Logs">
        <span class="link-text">Logs</span>
    </a>
    <a th:href="@{/compare}" th:classappend="${activePage == 'compare'} ? ' active' : ''">
        <img src="/img/compare.png" alt="Vergleichen">
        <span class="link-text">Vergleichen</span>
    </a>
	<a th:href="@{/alerts}" th:classappend="${activePage == 'alerts'} ? ' active' : ''">
	    <img src="/img/alert.png" alt="Meldungen ">
	    <span class="link-text">Meldungen</span>
	</a>
	<a th:href="@{/pdf-export}" th:classappend="${activePage == 'pdf-export'} ? ' active' : ''">
	    <img src="/img/pdf.png" alt="PDF-Creator ">
	    <span class="link-text">PDF-Creator</span>
	</a>
	<a th:if="${isAdmin}" th:href="@{/admin/manageUsers}" th:classappend="${activePage == 'manageUsers'} ? ' active' : ''">
	    <img src="/img/users.png" alt="Benutzer">
	    <span class="link-text">Benutzer</span>
	</a>
	<a th:if="${isAdmin}" th:href="@{/filemanager}" th:classappend="${activePage == 'filemanager'} ? ' active' : ''">
	    <img src="/img/folder.png" alt="Ordner">
	    <span class="link-text">Dateimanager</span>
	</a>
</div>

<div class="container">
    <div class="server-panel">
        <h2>Server A</h2>
        <select id="serverASelect"></select>
        <canvas id="cpuChartA"></canvas>
        <canvas id="ramChartA"></canvas>
        <canvas id="diskChartA"></canvas>
        <table>
            <tr><th>CPU (%)</th><th>RAM (%)</th><th>Disk (%)</th></tr>
            <tr><td id="cpuAvgA">-</td><td id="ramAvgA">-</td><td id="diskAvgA">-</td></tr>
        </table>
    </div>

    <div class="server-panel">
        <h2>Server B</h2>
        <select id="serverBSelect"></select>
        <canvas id="cpuChartB"></canvas>
        <canvas id="ramChartB"></canvas>
        <canvas id="diskChartB"></canvas>
        <table>
            <tr><th>CPU (%)</th><th>RAM (%)</th><th>Disk (%)</th></tr>
            <tr><td id="cpuAvgB">-</td><td id="ramAvgB">-</td><td id="diskAvgB">-</td></tr>
        </table>
    </div>
</div>

<script>
	const charts = {};
	const serverASelect = document.getElementById('serverASelect');
	const serverBSelect = document.getElementById('serverBSelect');
	
	async function fetchServers() {
	    const response = await fetch('/api/servers');
	    const data = await response.json();
	    console.log("Serverliste geladen:", data);
	    return data;
	}

	async function fetchHistory(serverName) {
	    const response = await fetch(`/api/server/${serverName}/history`);
	    const data = await response.json();
	    console.log(`History für ${serverName} geladen:`, data);
	    return data;
	}

	async function loadServerData(selectId, chartPrefix, tablePrefix) {
	    console.log("loadServerData gestartet");
	    const serverName = document.getElementById(selectId).value;
	    const history = await fetchHistory(serverName);

	    const labels = history.map(d => new Date(d.timestamp).toLocaleTimeString());
	    const cpuData = history.map(d => d.cpuPercent);
	    const ramData = history.map(d => d.ramUsed);
	    const diskData = history.map(d => d.diskPercent);

	    console.log("CPU:", cpuData);
	    console.log("RAM:", ramData);
	    console.log("Disk:", diskData);

	    drawChart(`cpuChart${chartPrefix}`, labels, cpuData, 'CPU (%)');
	    drawChart(`ramChart${chartPrefix}`, labels, ramData, 'RAM (%)');
	    drawChart(`diskChart${chartPrefix}`, labels, diskData, 'Disk (%)');

	    document.getElementById(`cpuAvg${tablePrefix}`).textContent = avg(cpuData).toFixed(1);
	    document.getElementById(`ramAvg${tablePrefix}`).textContent = avg(ramData).toFixed(1);
	    document.getElementById(`diskAvg${tablePrefix}`).textContent = avg(diskData).toFixed(1);
	}

	const colors = {
	    'CPU (%)': {border: 'rgba(255, 99, 132, 1)', background: 'rgba(255, 99, 132, 0.2)'},
	    'RAM (%)': {border: 'rgba(54, 162, 235, 1)', background: 'rgba(54, 162, 235, 0.25)'},
	    'Disk (%)': {border: 'rgba(255, 206, 86, 1)', background: 'rgba(255, 206, 86, 0.2)'}
	};
	
	function drawChart(id, labels, data, label) {
	    const ctx = document.getElementById(id).getContext('2d');
	    const color = colors[label] || {border: '#4a90e2', background: '#4a90e2'};
	    if (charts[id]) charts[id].destroy();
	    charts[id] = new Chart(ctx, {
	        type: 'line',
	        data: {
	            labels,
	            datasets: [{
	                label,
	                data,
	                fill: true,
	                borderColor: color.border,
	                backgroundColor: color.background,
	                tension: 0.3,
	                pointRadius: 2,
	                borderWidth: 2,
	            }]
	        },
	        options: {
	            responsive: true,
	            maintainAspectRatio: false,
	            plugins: {
	                legend: {
	                    display: true,
	                    labels: { color: '#ddd', font: { size: 14 } }
	                },
	                datalabels: {
	                    color: '#ddd',
	                    font: { weight: 'bold' },
	                    display: false,
	                    align: 'top',
	                    formatter: value => value.toFixed(1)
	                }
	            },
	            scales: {
	                x: { ticks: { color: '#ccc' }, grid: { color: '#333' } },
	                y: { ticks: { color: '#ccc' }, grid: { color: '#333' }, beginAtZero: true }
	            }
	        },
	        plugins: [ChartDataLabels],
	    });
	}



	function avg(arr) {
	    if (!arr.length) return 0;
	    return arr.reduce((a, b) => a + b, 0) / arr.length;
	}

    async function init() {
        const servers = await fetchServers();

        servers.forEach(server => {
            const opt1 = new Option(server.name, server.name);
            const opt2 = new Option(server.name, server.name);
            serverASelect.appendChild(opt1);
            serverBSelect.appendChild(opt2);
        });

		serverASelect.addEventListener('change', () => loadServerData('serverASelect', 'A', 'A'));
		serverBSelect.addEventListener('change', () => loadServerData('serverBSelect', 'B', 'B'));

		if (servers.length >= 2) {
		    serverASelect.value = servers[0].name;
		    serverBSelect.value = servers[1].name;
		    loadServerData('serverASelect', 'A', 'A');
		    loadServerData('serverBSelect', 'B', 'B');
		}
    }

    init();
	
	function toggleSidebar() {
	    const sidebar = document.getElementById('sidebar');
	    sidebar.classList.toggle('expanded');

	    // body margin anpassen
	    if (sidebar.classList.contains('expanded')) {
	        document.body.classList.add('sidebar-expanded');
	    } else {
	        document.body.classList.remove('sidebar-expanded');
	    }
	}
</script>
</body>
</html>
